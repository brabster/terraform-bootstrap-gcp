name: Cleanup PR Images

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest # maintained by GitHub
    permissions:
      packages: write
    steps:
      - name: Delete PR image
        run: |
          set -euo pipefail
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          IMAGE_NAME="ghcr.io/${{ github.repository }}"
          TAG="pr-${PR_NUMBER}"
          
          echo "Attempting to delete image tag: ${IMAGE_NAME}:${TAG}"
          
          # Authenticate to GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Get the package version ID for the PR tag using GitHub API
          # The GitHub Container Registry uses the GitHub Packages API
          PACKAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # List all versions and find the one with our PR tag
          VERSIONS=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME#*/}/versions")
          
          # Extract version ID for the PR tag
          VERSION_ID=$(echo "$VERSIONS" | jq -r --arg tag "$TAG" '.[] | select(.metadata.container.tags[] == $tag) | .id')
          
          if [ -n "$VERSION_ID" ] && [ "$VERSION_ID" != "null" ]; then
            echo "Found version ID: ${VERSION_ID} for tag ${TAG}"
            
            # Delete the package version
            curl -L \
              -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME#*/}/versions/${VERSION_ID}"
            
            echo "Successfully deleted image tag: ${TAG}"
          else
            echo "No image found with tag: ${TAG} (this may be expected if the PR was closed before image publication)"
          fi
