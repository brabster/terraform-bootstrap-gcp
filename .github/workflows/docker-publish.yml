name: Docker Image CI

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * *'
  push:
    branches:
      - main
    paths:
      - Dockerfile
      - requirements.txt
      - .github/**
      - scripts/**

env:
  DOCKER_SHA_TAG: ghcr.io/${{ github.repository }}:${{ github.sha }}
  DOCKER_LATEST_TAG: ghcr.io/${{ github.repository }}:latest

jobs:
  build_and_load:
    runs-on: ubuntu-latest # maintained by GitHub
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v3 # maintained by GitHub

    - name: Log in to the Container registry
      uses: docker/login-action@v3 # maintained by Docker
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and export Docker image
      run: |
        docker build -t candidate_image:latest .
        docker save candidate_image:latest -o ${{ runner.temp }}/candidate_image.tar
      
    - name: Upload image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: candidate_image
        path: ${{ runner.temp }}/candidate_image.tar

  osv_scan:
    runs-on: ubuntu-latest # maintained by GitHub
    permissions:
      contents: read
      actions: read
      security-events: write
    needs: build_and_load
    steps:

    - uses: actions/checkout@v3 # maintained by GitHub

    - name: Download image artifact
      uses: actions/download-artifact@v4 # maintained by GitHub
      with:
        name: candidate_image
        path: ${{ runner.temp }}

    - name: vuln_scan
      run: |
        scripts/install_osv_scanner

        docker load -i ${{ runner.temp }}/candidate_image.tar

        osv-scanner scan image candidate_image:latest
        

  image_test:
    runs-on: ubuntu-latest # maintained by GitHub
    needs: build_and_load
    steps:

      - name: Download image artifact
        uses: actions/download-artifact@v4 # maintained by GitHub
        with:
          name: candidate_image
          path: ${{ runner.temp }}

      - name: test
        run: |
          docker load -i ${{ runner.temp }}/candidate_image.tar
          docker run --rm candidate_image:latest bash -c " \
            set -e && \
            echo '--- Checking Terraform ---' && terraform --version && \
            echo '--- Checking gcloud ---' && gcloud --version && \
            echo '--- Checking Python ---' && python --version \
          "

  # publish:
  #   runs-on: ubuntu-latest # maintained by GitHub
  #   permissions:
  #     packages: write
  #     security-events: write
  #   needs:
  #     - build_and_load
  #     - osv_scan
  #     - image_test
  #   steps:
  #   - name: Push Docker image
  #     run: |
  #       echo "${{ needs.build_and_load.outputs.image_tags }}" | sed 's/,/\n/g' | xargs -I {} docker push {}

